# ç»Šçº¿å…¥ä¾µæ£€æµ‹ç³»ç»Ÿ - åç«¯APIå¯¹æ¥ç‰ˆæœ¬ä½¿ç”¨è¯´æ˜

## æ¦‚è¿°

`tripwire_detector_api.py` æ˜¯ä¸€ä¸ªä¸åç«¯APIæ·±åº¦é›†æˆçš„å¤šæµå¹¶è¡Œæ£€æµ‹ç³»ç»Ÿï¼Œæ”¯æŒï¼š

- âœ… è‡ªåŠ¨ç™»å½•ä¸ä¿æ´»
- âœ… åŠ¨æ€è·å–è®¾å¤‡é…ç½®å’Œè§†é¢‘æµåœ°å€
- âœ… å¤šè§†é¢‘æµå¹¶è¡Œæ£€æµ‹
- âœ… å‰ç«¯åæ ‡åˆ°å®é™…æµåæ ‡çš„è‡ªåŠ¨è½¬æ¢
- âœ… æŠ¥è­¦ä¿¡æ¯è‡ªåŠ¨ä¸Šä¼ 
- âœ… é…ç½®çƒ­æ›´æ–°ï¼ˆæ— éœ€é‡å¯ï¼‰
- âœ… è§†é¢‘æµè‡ªåŠ¨é‡è¿
- âœ… å…¨å±€å†·å´æœºåˆ¶ï¼ˆé€šé“çº§åˆ«ï¼‰

## ç³»ç»Ÿæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        ä¸»ç¨‹åº                                â”‚
â”‚  - ç™»å½•è®¤è¯                                                  â”‚
â”‚  - ä¿æ´»çº¿ç¨‹                                                  â”‚
â”‚  - é…ç½®æ›´æ–°å¾ªç¯                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   DetectionManager                           â”‚
â”‚  - ç®¡ç†å¤šä¸ªæ£€æµ‹è¿›ç¨‹                                          â”‚
â”‚  - å¯åŠ¨/åœæ­¢/é‡è½½æ£€æµ‹å™¨                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚        â”‚        â”‚        â”‚
         â–¼        â–¼        â–¼        â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚é€šé“1   â”‚â”‚é€šé“2   â”‚â”‚é€šé“3   â”‚â”‚é€šé“N   â”‚
    â”‚æ£€æµ‹è¿›ç¨‹â”‚â”‚æ£€æµ‹è¿›ç¨‹â”‚â”‚æ£€æµ‹è¿›ç¨‹â”‚â”‚æ£€æµ‹è¿›ç¨‹â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚        â”‚        â”‚        â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚ åç«¯API      â”‚
         â”‚ - è§†é¢‘æµ     â”‚
         â”‚ - æŠ¥è­¦ä¸Šä¼    â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## æ ¸å¿ƒæ¨¡å—

### 1. APIClient - APIå®¢æˆ·ç«¯
- `login()` - ç™»å½•è·å–token
- `keep_alive()` - ä¿æŒç™»å½•çŠ¶æ€
- `get_device_config()` - è·å–è®¾å¤‡é…ç½®
- `get_stream_url()` - è·å–è§†é¢‘æµåœ°å€
- `upload_alarm()` - ä¸Šä¼ æŠ¥è­¦ä¿¡æ¯

### 2. ConfigManager - é…ç½®ç®¡ç†å™¨
- `parse_device_config()` - è§£æè®¾å¤‡é…ç½®ï¼Œç­›é€‰ç»Šçº¿å…¥ä¾µè§„åˆ™
- `convert_tripwire_points()` - åæ ‡è½¬æ¢ï¼ˆå‰ç«¯ â†’ å®é™…è§†é¢‘æµï¼‰
- `compare_configs()` - é…ç½®å·®å¼‚æ£€æµ‹

### 3. DetectionManager - å¤šæµç®¡ç†å™¨
- `start_detector()` - å¯åŠ¨å•ä¸ªæ£€æµ‹è¿›ç¨‹
- `stop_detector()` - åœæ­¢æ£€æµ‹è¿›ç¨‹
- `reload_detector()` - é‡å¯æ£€æµ‹è¿›ç¨‹ï¼ˆé…ç½®å˜æ›´æ—¶ï¼‰
- `stop_all()` - åœæ­¢æ‰€æœ‰æ£€æµ‹è¿›ç¨‹

### 4. stream_detector_worker - æ£€æµ‹è¿›ç¨‹
- ç‹¬ç«‹è¿›ç¨‹è¿è¡Œï¼Œäº’ä¸å¹²æ‰°
- è‡ªåŠ¨é‡è¿æœºåˆ¶
- ç»Šçº¿ç©¿è¶Šæ£€æµ‹
- æŠ¥è­¦è§¦å‘ä¸ä¸Šä¼ 

## ä½¿ç”¨æ–¹æ³•

### åŸºæœ¬ç”¨æ³•

```bash
python tripwire_intrusion/tripwire_detector_api.py \
    --api-url http://localhost:8080 \
    --username admin \
    --password admin123 \
    --model-yaml ultralytics/cfg/models/11/yolo11x.yaml \
    --weights data/LLVIP_IF-yolo11x-e300-16-pretrained.pt \
    --device cuda:0
```

### å‚æ•°è¯´æ˜

#### å¿…éœ€å‚æ•°

| å‚æ•° | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|
| `--api-url` | åç«¯APIåŸºç¡€URL | `http://192.168.1.100:8080` |
| `--username` | ç™»å½•ç”¨æˆ·å | `admin` |
| `--password` | ç™»å½•å¯†ç  | `admin123` |

#### å¯é€‰å‚æ•°

| å‚æ•° | é»˜è®¤å€¼ | è¯´æ˜ |
|------|--------|------|
| `--model-yaml` | `ultralytics/cfg/models/11/yolo11x.yaml` | æ¨¡å‹é…ç½®æ–‡ä»¶ |
| `--weights` | `data/LLVIP_IF-yolo11x-e300-16-pretrained.pt` | æ¨¡å‹æƒé‡æ–‡ä»¶ |
| `--device` | `cuda:0` | è®¡ç®—è®¾å¤‡ï¼ˆ`cuda:0` æˆ– `cpu`ï¼‰ |
| `--target-size` | `640` | YOLOæ£€æµ‹è¾“å…¥å°ºå¯¸ |
| `--process-fps` | `5.0` | æ¯ç§’å¤„ç†å¸§æ•°ï¼ˆæŠ½å¸§ï¼‰ |
| `--config-update-interval` | `30` | é…ç½®æ›´æ–°é—´éš”ï¼ˆç§’ï¼‰ |
| `--tracker` | `bytetrack` | è·Ÿè¸ªå™¨ç±»å‹ï¼ˆ`bytetrack` æˆ– `botsort`ï¼‰ |
| `--draw-trajectory` | `True` | æ˜¯å¦ç»˜åˆ¶è½¨è¿¹ |
| `--trajectory-length` | `30` | è½¨è¿¹æ˜¾ç¤ºé•¿åº¦ |

### å®Œæ•´ç¤ºä¾‹

```bash
# å¼€å‘/è°ƒè¯•æ¨¡å¼ï¼ˆ30ç§’æ›´æ–°ä¸€æ¬¡é…ç½®ï¼‰
python tripwire_intrusion/tripwire_detector_api.py \
    --api-url http://192.168.1.100:8080 \
    --username admin \
    --password admin123 \
    --model-yaml ultralytics/cfg/models/11/yolo11x.yaml \
    --weights data/LLVIP_IF-yolo11x-e300-16-pretrained.pt \
    --device cuda:0 \
    --target-size 640 \
    --process-fps 5 \
    --config-update-interval 30 \
    --tracker bytetrack \
    --draw-trajectory \
    --trajectory-length 30

# ç”Ÿäº§æ¨¡å¼ï¼ˆ5åˆ†é’Ÿæ›´æ–°ä¸€æ¬¡é…ç½®ï¼‰
python tripwire_intrusion/tripwire_detector_api.py \
    --api-url http://192.168.1.100:8080 \
    --username admin \
    --password admin123 \
    --config-update-interval 300
```

## å·¥ä½œæµç¨‹

### 1. å¯åŠ¨é˜¶æ®µ

```
[1/5] ç™»å½•åç«¯ç³»ç»Ÿ
  â†“
[2/5] å¯åŠ¨ä¿æ´»çº¿ç¨‹ï¼ˆæ¯5åˆ†é’Ÿè°ƒç”¨ä¸€æ¬¡ï¼‰
  â†“
[3/5] è·å–åˆå§‹é…ç½®
  â†“
[4/5] å¯åŠ¨æ£€æµ‹ç®¡ç†å™¨
  â”œâ”€ ç­›é€‰å¯ç”¨ä¸”å¸ƒé˜²çš„é€šé“
  â”œâ”€ ä¸ºæ¯ä¸ªé€šé“å¯åŠ¨ç‹¬ç«‹æ£€æµ‹è¿›ç¨‹
  â””â”€ æ‰“å°æ£€æµ‹å™¨çŠ¶æ€
  â†“
[5/5] é…ç½®æ›´æ–°å¾ªç¯
```

### 2. å•é€šé“æ£€æµ‹æµç¨‹

```
è·å–è§†é¢‘æµåœ°å€
  â†“
åˆå§‹åŒ– YOLO æ¨¡å‹ï¼ˆå¸¦è·Ÿè¸ªå™¨ï¼‰
  â†“
æ‰“å¼€RTSPæµ
  â†“
è·å–å®é™…è§†é¢‘æµå°ºå¯¸
  â†“
åæ ‡è½¬æ¢ï¼ˆå‰ç«¯ â†’ å®é™…ï¼‰
  â†“
åŠ¨æ€ç”Ÿæˆç»Šçº¿é…ç½®
  â†“
åˆå§‹åŒ– TripwireMonitorï¼ˆå…¨å±€å†·å´ï¼‰
  â†“
åˆå§‹åŒ– TripwireVisualizer
  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å¸§å¤„ç†å¾ªç¯      â”‚
â”‚  1. è¯»å–å¸§      â”‚
â”‚  2. æŠ½å¸§æ£€æµ‹    â”‚
â”‚  3. YOLOè·Ÿè¸ª    â”‚
â”‚  4. æ›´æ–°è½¨è¿¹    â”‚
â”‚  5. ç»Šçº¿ç›‘æ§    â”‚
â”‚  6. æŠ¥è­¦ä¸Šä¼     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â†“ï¼ˆå¦‚æœæµæ–­å¼€ï¼‰
è‡ªåŠ¨é‡è¿ï¼ˆæœ€å¤š5æ¬¡ï¼‰
```

### 3. é…ç½®æ›´æ–°æµç¨‹

```
å®šæ—¶è§¦å‘ï¼ˆé»˜è®¤30ç§’ï¼‰
  â†“
è·å–æœ€æ–°é…ç½®
  â†“
è§£æé…ç½®
  â†“
æ¯”å¯¹æ–°æ—§é…ç½®
  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å¤„ç†å˜æ›´         â”‚
â”‚ - æ–°å¢é€šé“ â†’ å¯åŠ¨â”‚
â”‚ - åˆ é™¤é€šé“ â†’ åœæ­¢â”‚
â”‚ - æ›´æ–°é€šé“ â†’ é‡å¯â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â†“
æ›´æ–°å½“å‰é…ç½®
```

## APIé…ç½®æ ¼å¼

### åç«¯è¿”å›çš„è®¾å¤‡é…ç½®

ä» `/artificial/api/listDeviceAndChannel` æ¥å£è·å–ï¼Œæå– `algorithmCode == 'tripwire_intrusion'` çš„è§„åˆ™ï¼š

```json
{
  "result": [
    {
      "deviceId": "1996128063770456065",
      "deviceName": "èµ°å»Šè¿‡é“3",
      "deviceCode": "34020000001110000001",
      "deviceIp": "192.128.22.15",
      "deviceChannelVos": [
        {
          "channelId": "1996128137292410881",
          "channelName": "èµ°å»Šè¿‡é“3",
          "channelCode": "1996128063770456065",
          "algorithmRules": [
            {
              "algorithmCode": "tripwire_intrusion",
              "izEnable": "1",
              "sensitivity": 5,
              "repeatedAlarmTime": 30.0,
              "direction": "bidirectional",
              "width": 1920,
              "height": 1080,
              "algorithmRulePoints": [
                {
                  "groupType": "polyline",
                  "pointStr": "[[100,200],[300,400],[500,600]]"
                }
              ]
            }
          ]
        }
      ]
    }
  ]
}
```

### æå–çš„é…ç½®å­—æ®µ

| å­—æ®µ | è¯´æ˜ | ç¤ºä¾‹å€¼ |
|------|------|--------|
| `sensitivity` | çµæ•åº¦ï¼ˆ1-10ï¼‰ | `5` â†’ æ˜ å°„ä¸ºç½®ä¿¡åº¦é˜ˆå€¼ `0.45` |
| `repeatedAlarmTime` | é‡å¤æŠ¥è­¦é—´éš”ï¼ˆç§’ï¼‰ | `30.0` |
| `direction` | ç»Šçº¿æ–¹å‘ | `"left_to_right"`, `"right_to_left"`, `"bidirectional"` |
| `width` | å‰ç«¯æ˜¾ç¤ºå®½åº¦ | `1920` |
| `height` | å‰ç«¯æ˜¾ç¤ºé«˜åº¦ | `1080` |
| `izEnable` | æ˜¯å¦å¯ç”¨ | `"1"` (å¯ç”¨), `"0"` (ç¦ç”¨) |
| `pointStr` | ç»Šçº¿ç‚¹ä½ï¼ˆpolylineï¼‰ | `"[[100,200],[300,400],[500,600]]"` |

### pointStr è§£æè§„åˆ™

**ç›¸é‚»ç‚¹è¿çº¿ç”Ÿæˆç»Šçº¿**ï¼š

```json
// è¾“å…¥ï¼špointStr
"[[100,200], [300,400], [500,600], [700,800]]"

// è§£æä¸º 3 æ¡ç»Šçº¿ï¼š
// ç»Šçº¿1: [100,200] â†’ [300,400]  (ç‚¹0-ç‚¹1)
// ç»Šçº¿2: [300,400] â†’ [500,600]  (ç‚¹1-ç‚¹2)
// ç»Šçº¿3: [500,600] â†’ [700,800]  (ç‚¹2-ç‚¹3)

// è§„åˆ™ï¼šNä¸ªç‚¹ = N-1æ¡ç»Šçº¿
```

## åæ ‡è½¬æ¢æœºåˆ¶

### é—®é¢˜èƒŒæ™¯

å‰ç«¯é…ç½®çš„ç»Šçº¿ç‚¹ä½æ˜¯åŸºäº**å‰ç«¯æ˜¾ç¤ºåˆ†è¾¨ç‡**ï¼ˆå¦‚ 1920x1080ï¼‰ï¼Œä½†å®é™…è§†é¢‘æµå¯èƒ½æ˜¯å…¶ä»–åˆ†è¾¨ç‡ï¼ˆå¦‚ 1280x720ï¼‰ã€‚ç›´æ¥ä½¿ç”¨å‰ç«¯åæ ‡ä¼šå¯¼è‡´ç»Šçº¿ä½ç½®é”™ä½ã€‚

### è§£å†³æ–¹æ¡ˆ

è‡ªåŠ¨è·å–å®é™…è§†é¢‘æµåˆ†è¾¨ç‡ï¼Œå¹¶æŒ‰æ¯”ä¾‹è½¬æ¢ç‚¹ä½åæ ‡ï¼š

```python
# å‰ç«¯é…ç½®
frontend_width = 1920
frontend_height = 1080
frontend_points = [[[100, 200], [300, 400]], [[500, 600], [700, 800]]]

# å®é™…è§†é¢‘æµ
actual_width = 1280
actual_height = 720

# è®¡ç®—ç¼©æ”¾æ¯”ä¾‹
scale_x = actual_width / frontend_width    # 1280 / 1920 = 0.667
scale_y = actual_height / frontend_height  # 720 / 1080 = 0.667

# è½¬æ¢æ¯æ¡ç»Šçº¿
actual_tripwires = []
for line_points in frontend_points:
    actual_line = []
    for [x, y] in line_points:
        actual_x = int(x * scale_x)  # 100 * 0.667 = 67
        actual_y = int(y * scale_y)  # 200 * 0.667 = 133
        actual_line.append([actual_x, actual_y])
    actual_tripwires.append(actual_line)
```

## æŠ¥è­¦æœºåˆ¶

### å…¨å±€å†·å´ç­–ç•¥

**é€šé“çº§åˆ«çš„å…¨å±€å†·å´**ï¼š
- ä¸€ä¸ªé€šé“çš„æ‰€æœ‰ç»Šçº¿å…±äº«åŒä¸€ä¸ªå†·å´æ—¶é—´
- ä»»æ„ç»Šçº¿è§¦å‘æŠ¥è­¦åï¼Œæ•´ä¸ªé€šé“è¿›å…¥å†·å´æœŸ
- å†·å´æœŸå†…ï¼Œè¯¥é€šé“çš„æ‰€æœ‰ç»Šçº¿éƒ½ä¸ä¼šå†æ¬¡æŠ¥è­¦
- å†·å´æ—¶é—´ç”±åç«¯é…ç½®çš„ `repeatedAlarmTime` å†³å®š

### æŠ¥è­¦æ¡ä»¶

1. **ç½®ä¿¡åº¦è¿‡æ»¤**ï¼šæ£€æµ‹ç½®ä¿¡åº¦ â‰¥ `sensitivity`ï¼ˆä»åç«¯é…ç½®è·å–ï¼‰
2. **è½¨è¿¹ç›¸äº¤**ï¼šç›®æ ‡è½¨è¿¹ä¸ç»Šçº¿ç›¸äº¤
3. **æ–¹å‘åŒ¹é…**ï¼šç©¿è¶Šæ–¹å‘ç¬¦åˆç»Šçº¿è®¾å®šï¼ˆ`left_to_right` / `right_to_left` / `bidirectional`ï¼‰
4. **å…¨å±€å†·å´**ï¼šè·ç¦»è¯¥é€šé“ä¸Šæ¬¡æŠ¥è­¦ â‰¥ `repeatedAlarmTime`

### æŠ¥è­¦æµç¨‹

```
ç›®æ ‡è·Ÿè¸ªä¸­...
  â†“
è½¨è¿¹ä¸ç»Šçº¿ç›¸äº¤
  â†“
è®¡ç®—ç©¿è¶Šæ–¹å‘
  â†“
æ–¹å‘åŒ¹é…ï¼Ÿ
  â†“ æ˜¯
æ£€æŸ¥å…¨å±€å†·å´æ—¶é—´
  â†“
å†·å´æœŸå·²è¿‡ï¼Ÿ
  â†“ æ˜¯
è§¦å‘æŠ¥è­¦
  â”œâ”€ å¯è§†åŒ–æ£€æµ‹ç»“æœ
  â”œâ”€ ç¼©æ”¾åˆ°å‰ç«¯æ˜¾ç¤ºå°ºå¯¸
  â”œâ”€ Base64ç¼–ç 
  â””â”€ ä¸Šä¼ åˆ°åç«¯API
  â†“
æ›´æ–°å…¨å±€å†·å´æ—¶é—´
```

### æŠ¥è­¦æ•°æ®æ ¼å¼

```json
{
  "deviceId": "1996128063770456065",
  "deviceName": "34020000001110000001",
  "deviceCode": "èµ°å»Šè¿‡é“3",
  "deviceIp": "192.128.22.15",
  "channelId": "1996128137292410881",
  "channelName": "èµ°å»Šè¿‡é“3",
  "channelCode": "1996128063770456065",
  "alarmPicCode": "base64_encoded_image...",
  "nodeType": "2",
  "alarmDate": "2025-12-10 15:30:00",
  "alarmType": "tripwire_intrusion",
  "alarmTypeName": "ç»Šçº¿å…¥ä¾µ"
}
```

## é…ç½®çƒ­æ›´æ–°

ç³»ç»Ÿä¼šå®šæœŸæ£€æŸ¥åç«¯é…ç½®å˜åŒ–ï¼Œå¹¶è‡ªåŠ¨åº”å¯¹ï¼š

| å˜åŒ–ç±»å‹ | å¤„ç†æ–¹å¼ | è¯´æ˜ |
|---------|---------|------|
| æ–°å¢é€šé“ | å¯åŠ¨æ–°çš„æ£€æµ‹è¿›ç¨‹ | è‡ªåŠ¨è·å–æµåœ°å€å¹¶å¼€å§‹æ£€æµ‹ |
| åˆ é™¤é€šé“ | åœæ­¢å¯¹åº”æ£€æµ‹è¿›ç¨‹ | ä¼˜é›…å…³é—­ï¼Œé‡Šæ”¾èµ„æº |
| é…ç½®æ›´æ–° | é‡å¯æ£€æµ‹è¿›ç¨‹ | åœæ­¢æ—§è¿›ç¨‹ï¼Œå¯åŠ¨æ–°è¿›ç¨‹åº”ç”¨æ–°é…ç½® |

**æ¯”è¾ƒçš„é…ç½®å­—æ®µ**ï¼š
- `sensitivity` - ç½®ä¿¡åº¦é˜ˆå€¼
- `repeated_alarm_time` - é‡å¤æŠ¥è­¦é—´éš”
- `direction` - ç»Šçº¿æ–¹å‘
- `frontend_width` - å‰ç«¯å®½åº¦
- `frontend_height` - å‰ç«¯é«˜åº¦
- `tripwire_points` - ç»Šçº¿ç‚¹ä½
- `is_enable` - æ˜¯å¦å¯ç”¨

## è‡ªåŠ¨é‡è¿æœºåˆ¶

å½“è§†é¢‘æµæ–­å¼€æ—¶ï¼Œæ£€æµ‹è¿›ç¨‹ä¼šè‡ªåŠ¨å°è¯•é‡è¿ï¼š

- **æœ€å¤§é‡è¯•æ¬¡æ•°**ï¼š5æ¬¡
- **é‡è¿é—´éš”**ï¼š5ç§’

```python
retry_count = 0
max_retries = 5
retry_delay = 5

while not stop_event.is_set() and retry_count < max_retries:
    try:
        cap = cv2.VideoCapture(stream_url)
        # ... æ£€æµ‹æµç¨‹ ...
        retry_count = 0  # æˆåŠŸåé‡ç½®è®¡æ•°
    except Exception:
        retry_count += 1
        time.sleep(retry_delay)
```

## æ—¥å¿—ç³»ç»Ÿ

ä½¿ç”¨ Python `logging` æ¨¡å—ï¼Œæ—¥å¿—æ ¼å¼ï¼š

```
2025-12-10 15:30:00 [INFO] âœ“ ç™»å½•æˆåŠŸ
2025-12-10 15:30:01 [INFO] ä¿æ´»çº¿ç¨‹å¯åŠ¨ï¼ˆé—´éš”: 300sï¼‰
2025-12-10 15:30:02 [INFO] âœ“ è§£æé€šé“é…ç½®: è®¾å¤‡A/é€šé“1 (ç»Šçº¿æ•°: 3)
2025-12-10 15:30:03 [INFO] âœ“ å¯åŠ¨æ£€æµ‹å™¨: è®¾å¤‡A/é€šé“1
2025-12-10 15:30:10 [INFO] ğŸš¨ [15:30:10] Track 1 crossed device_line_0 (left_to_right)
```

### æ—¥å¿—çº§åˆ«

- `INFO` - é‡è¦æ“ä½œå’ŒçŠ¶æ€å˜åŒ–
- `DEBUG` - è¯¦ç»†è°ƒè¯•ä¿¡æ¯ï¼ˆéœ€ä¿®æ”¹ä»£ç å¯ç”¨ï¼‰
- `WARNING` - è­¦å‘Šä¿¡æ¯ï¼ˆå¦‚ä¿æ´»å¤±è´¥ï¼‰
- `ERROR` - é”™è¯¯ä¿¡æ¯ï¼ˆå¦‚ç™»å½•å¤±è´¥ã€é…ç½®è§£æé”™è¯¯ï¼‰

## æ€§èƒ½ä¼˜åŒ–

### 1. æŠ½å¸§å¤„ç†

é€šè¿‡ `--process-fps` å‚æ•°æ§åˆ¶æ£€æµ‹é¢‘ç‡ï¼Œé™ä½GPUè´Ÿè½½ï¼š

```bash
# æ¯ç§’å¤„ç†2å¸§ï¼ˆé€‚åˆé«˜åˆ†è¾¨ç‡æµï¼‰
--process-fps 2

# æ¯ç§’å¤„ç†5å¸§ï¼ˆé»˜è®¤ï¼Œå¹³è¡¡æ€§èƒ½ä¸å®æ—¶æ€§ï¼‰
--process-fps 5

# æ¯ç§’å¤„ç†30å¸§ï¼ˆé«˜å®æ—¶æ€§è¦æ±‚ï¼‰
--process-fps 30
```

### 2. è·Ÿè¸ªå™¨é€‰æ‹©

| è·Ÿè¸ªå™¨ | é€Ÿåº¦ | ç²¾åº¦ | æ¨èåœºæ™¯ |
|--------|------|------|---------|
| `bytetrack` | å¿« | ä¸­ç­‰ | é»˜è®¤æ¨èï¼Œé€‚åˆå¤§å¤šæ•°åœºæ™¯ |
| `botsort` | æ…¢ | é«˜ | éœ€è¦é«˜ç²¾åº¦è·Ÿè¸ªçš„åœºæ™¯ |

### 3. æ¨¡å‹é€‰æ‹©

| æ¨¡å‹ | é€Ÿåº¦ | ç²¾åº¦ | æ¨èåœºæ™¯ |
|------|------|------|---------|
| yolo11n | æœ€å¿« | ä½ | å¤šæµå¹¶å‘ï¼ˆ>10è·¯ï¼‰ |
| yolo11s | å¿« | ä¸­ç­‰ | å¹³è¡¡æ¨¡å¼ï¼ˆ5-10è·¯ï¼‰ |
| yolo11m | ä¸­ç­‰ | é«˜ | ç²¾åº¦ä¼˜å…ˆï¼ˆ3-5è·¯ï¼‰ |
| yolo11x | æ…¢ | æœ€é«˜ | å•æµ/åŒæµ |

## å¸¸è§é—®é¢˜

### Q1: å¦‚ä½•æŸ¥çœ‹æ£€æµ‹æ•ˆæœï¼Ÿ

å½“å‰ç‰ˆæœ¬ä¸åŒ…å«å¯è§†åŒ–çª—å£ï¼ˆç”¨äºæœåŠ¡å™¨éƒ¨ç½²ï¼‰ã€‚å¯ä»¥é€šè¿‡æ—¥å¿—æŸ¥çœ‹æ£€æµ‹çŠ¶æ€ï¼ŒæŠ¥è­¦å›¾ç‰‡ä¼šä¿å­˜åˆ°ä¸´æ—¶ç›®å½•ã€‚

### Q2: å¦‚ä½•è°ƒæ•´æŠ¥è­¦çµæ•åº¦ï¼Ÿ

åœ¨åç«¯ç®¡ç†ç•Œé¢è°ƒæ•´ä»¥ä¸‹å‚æ•°ï¼š
- `sensitivity` - ç½®ä¿¡åº¦é˜ˆå€¼ï¼ˆ1=æœ€ä½çµæ•åº¦/0.85ï¼Œ10=æœ€é«˜çµæ•åº¦/0.10ï¼‰
- `repeatedAlarmTime` - é‡å¤æŠ¥è­¦é—´éš”ï¼ˆè¶ŠçŸ­è¶Šé¢‘ç¹ï¼‰

### Q3: å¦‚ä½•å¤„ç†è¯¯æŠ¥ï¼Ÿ

1. æé«˜ `sensitivity`ï¼ˆå¦‚ 5 â†’ 3ï¼‰
2. å¢åŠ  `repeatedAlarmTime`ï¼ˆå¦‚ 30s â†’ 60sï¼‰
3. è°ƒæ•´ç»Šçº¿ä½ç½®å’Œæ–¹å‘è®¾ç½®

### Q4: è§†é¢‘æµä¸€ç›´é‡è¿å¤±è´¥æ€ä¹ˆåŠï¼Ÿ

1. æ£€æŸ¥ç½‘ç»œè¿æ¥
2. éªŒè¯RTSPåœ°å€æ˜¯å¦æ­£ç¡®
3. æ£€æŸ¥æ‘„åƒå¤´æ˜¯å¦åœ¨çº¿
4. æŸ¥çœ‹æ—¥å¿—ä¸­çš„é”™è¯¯ä¿¡æ¯

### Q5: é…ç½®æ›´æ–°åæ²¡æœ‰ç”Ÿæ•ˆï¼Ÿ

1. æ£€æŸ¥ `izEnable` æ˜¯å¦ä¸º `"1"`
2. æŸ¥çœ‹æ—¥å¿—ï¼Œç¡®è®¤é…ç½®å˜åŒ–è¢«æ£€æµ‹åˆ°
3. æ£€æŸ¥é…ç½®æ›´æ–°é—´éš”æ˜¯å¦è¿‡é•¿

### Q6: CPU/GPUå ç”¨è¿‡é«˜ï¼Ÿ

1. é™ä½ `--process-fps`ï¼ˆå¦‚ 5 â†’ 2ï¼‰
2. ä½¿ç”¨æ›´è½»é‡çš„æ¨¡å‹ï¼ˆå¦‚ yolo11nï¼‰
3. ä½¿ç”¨æ›´å¿«çš„è·Ÿè¸ªå™¨ï¼ˆbytetrackï¼‰
4. å‡å°‘å¹¶å‘æ£€æµ‹çš„é€šé“æ•°

### Q7: å¤šæ¡ç»Šçº¿å¦‚ä½•é…ç½®ï¼Ÿ

åœ¨å‰ç«¯é¡µé¢ç»˜åˆ¶ç»Šçº¿æ—¶ï¼Œ**ä¾æ¬¡ç‚¹å‡»å„ä¸ªç‚¹**ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨å°†ç›¸é‚»ç‚¹è¿æˆçº¿ï¼š

```
ç‚¹å‡»é¡ºåºï¼šç‚¹1 â†’ ç‚¹2 â†’ ç‚¹3 â†’ ç‚¹4
ç”Ÿæˆç»Šçº¿ï¼š
  - çº¿1: ç‚¹1 â†’ ç‚¹2
  - çº¿2: ç‚¹2 â†’ ç‚¹3
  - çº¿3: ç‚¹3 â†’ ç‚¹4
```

## å¼€å‘å»ºè®®

### æ·»åŠ æ–°åŠŸèƒ½

1. **æ·»åŠ æ–°çš„APIæ¥å£**ï¼šåœ¨ `APIClient` ç±»ä¸­æ·»åŠ æ–¹æ³•
2. **ä¿®æ”¹æ£€æµ‹é€»è¾‘**ï¼šåœ¨ `stream_detector_worker` å‡½æ•°ä¸­ä¿®æ”¹
3. **è‡ªå®šä¹‰æŠ¥è­¦æ¡ä»¶**ï¼šä¿®æ”¹ `TripwireMonitor.update` æ–¹æ³•
4. **è°ƒæ•´æ—¥å¿—çº§åˆ«**ï¼šä¿®æ”¹ `logging.basicConfig(level=...)`

### è°ƒè¯•æŠ€å·§

```python
# 1. å¯ç”¨DEBUGæ—¥å¿—
logging.basicConfig(level=logging.DEBUG, ...)

# 2. å•é€šé“æµ‹è¯•ï¼ˆä¿®æ”¹é…ç½®è¿‡æ»¤æ¡ä»¶ï¼‰
if channel_id != 'æŒ‡å®šé€šé“ID':
    continue

# 3. ä¿å­˜æ£€æµ‹å¸§åˆ°æ–‡ä»¶
cv2.imwrite(f'debug_frame_{frame_count}.jpg', vis_frame)
```

## ä¸ area_intrusion çš„å·®å¼‚

| é¡¹ç›® | area_intrusion | tripwire_intrusion |
|------|----------------|-------------------|
| **ç®—æ³•ç±»å‹** | åŒºåŸŸå…¥ä¾µ | ç»Šçº¿å…¥ä¾µ |
| **æ£€æµ‹æ–¹å¼** | ROI mask + YOLOæ£€æµ‹ | YOLOè·Ÿè¸ª + çº¿æ®µç›¸äº¤ |
| **ç‚¹ä½ç±»å‹** | polygonï¼ˆå¤šè¾¹å½¢ï¼‰ | polylineï¼ˆæŠ˜çº¿ï¼‰ |
| **ç‚¹ä½è§£æ** | åŒºåŸŸåˆ—è¡¨ | ç›¸é‚»ç‚¹è¿çº¿ |
| **æŠ¥è­¦é€»è¾‘** | æŒç»­æ—¶é—´æ¶ˆæŠ– + å…¨å±€å†·å´ | ä»…å…¨å±€å†·å´ |
| **éœ€è¦è·Ÿè¸ª** | âŒ | âœ… |
| **é…ç½®å­—æ®µ** | sensitivity, firstAlarmTime, repeatedAlarmTime | sensitivity, repeatedAlarmTime, direction |

## è®¸å¯ä¸æ”¯æŒ

åŸºäº YOLOv11-RGBT é¡¹ç›®å¼€å‘ï¼Œéµå¾ªç›¸åŒçš„å¼€æºè®¸å¯ã€‚

å¦‚æœ‰é—®é¢˜ï¼Œè¯·å‚è€ƒï¼š
- ä¸»é¡¹ç›®æ–‡æ¡£ï¼š`CLAUDE.md`
- åŸå§‹æ£€æµ‹è„šæœ¬ï¼š`tripwire_intrusion/tripwire_detector.py`
- åŒºåŸŸå…¥ä¾µ API ç‰ˆæœ¬ï¼š`area_intrusion/intrusion_detector_api.py`
- YOLOv11-RGBTè®ºæ–‡ï¼šhttps://arxiv.org/abs/2506.14696
